// prisma/schema.prisma
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  SUPERADMIN
  ADMIN
  LEADER
  USER
}

enum FeedbackStatus {
  WRITTEN // ì‘ì„±ì™„ë£Œ(ì‘ì„±ìê°€ ë“±ë¡ë§Œ í•œ ìƒíƒœ)
  CONFIRMED // í™•ì¸ì™„ë£Œ(ìŠˆí¼ê´€ë¦¬ìê°€ ì—´ëŒ)
  IN_PROGRESS // ì²˜ë¦¬ì¤‘(ìŠˆí¼ê´€ë¦¬ìê°€ ìƒíƒœ ë³€ê²½)
  DONE // ì²˜ë¦¬ì™„ë£Œ(ìŠˆí¼ê´€ë¦¬ìê°€ ìƒì„¸ì—ì„œ ì™„ë£Œ)
  REJECTED // ë°˜ë ¤(ìŠˆí¼ê´€ë¦¬ìê°€ ë°˜ë ¤)
}

model ClanRequest {
  id            BigInt @id @default(autoincrement())
  world         String @db.VarChar(50)
  serverNo      Int
  clanName      String @db.VarChar(100)
  loginId       String @db.VarChar(50)
  passwordHash  String @db.VarChar(255)
  depositorName String @db.VarChar(50)

  status       RequestStatus @default(PENDING)
  reviewerNote String?       @db.VarChar(255)
  reviewedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([world, serverNo, clanName], name: "uq_world_server_clan")
  @@unique([world, serverNo, loginId], name: "uq_world_server_login")
  @@index([status, createdAt], name: "idx_status_created")
}

model Clan {
  id       BigInt @id @default(autoincrement())
  world    String @db.VarChar(50)
  serverNo Int
  name     String @db.VarChar(100)

  members         User[]
  timelines       BossTimeline[]
  treasuryEntries TreasuryLedger[] @relation("ClanTreasuryEntries")

  // â¬‡ï¸ BossCounterì™€ì˜ ê´€ê³„ (ì´ ì´ë¦„ì„ BossCounter ìª½ê³¼ ë™ì¼í•˜ê²Œ)
  bossCounters BossCounter[] @relation("ClanBossCounters")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([world, serverNo, name], name: "uq_world_server_name")
}

model User {
  id           BigInt   @id @default(autoincrement())
  clanId       BigInt?
  clan         Clan?    @relation(fields: [clanId], references: [id])
  loginId      String   @unique @db.VarChar(50)
  passwordHash String   @db.VarChar(255)
  role         UserRole @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // â¬‡ï¸ ì•„ë˜ 5ê°œëŠ” 'ì—­ë°©í–¥' ê´€ê³„ í•„ë“œ â€” DB ì»¬ëŸ¼ ëŠ˜ì–´ë‚˜ì§€ ì•ŠìŒ
  feedbackAuthored Feedback[]        @relation("FeedbackAuthor")
  feedbackHandled  Feedback[]        @relation("FeedbackHandler")
  feedbackDeleted  Feedback[]        @relation("FeedbackDeleter")
  commentAuthored  FeedbackComment[] @relation("FeedbackCommentAuthor")
  commentDeleted   FeedbackComment[] @relation("FeedbackCommentDeleter")

  @@index([clanId], name: "idx_user_clan")
}

model BossMeta {
  id         BigInt  @id @default(autoincrement())
  name       String  @unique @db.VarChar(50)
  respawn    Int
  isRandom   Boolean @default(false)
  location   String  @db.VarChar(255)
  tpSave     String? @db.VarChar(50)
  difficulty String? @db.VarChar(20)
  notes      String? @db.VarChar(255)
  orderNo    Int     @default(0)
  active     Boolean @default(true)

  isFixBoss String @default("N") @db.VarChar(1)

  /// 0~1439 (ìì •=0, 23:59=1439) â€” "ì‹œê°„ë§Œ" ì €ì¥
  genTime Int? @map("genTime") @db.SmallInt

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isFixBoss], map: "idx_bossmeta_isfixboss")
}

model BossTimeline {
  id BigInt @id @default(autoincrement())

  // Clan â†” BossTimeline ì–‘ë°©í–¥
  clanId BigInt
  clan   Clan   @relation(fields: [clanId], references: [id])

  bossName  String
  cutAt     DateTime
  createdBy String

  // â›”ï¸ String[] ë¶ˆê°€ â†’ âœ… Jsonìœ¼ë¡œ êµì²´ (ì•±ì—ì„œ []ì²˜ëŸ¼ ì‚¬ìš©)
  imageIds Json?

  respawn Int? // ë¶„ ë‹¨ìœ„

  // ë©(ë…¸ì  ) ëˆ„ì  íšŸìˆ˜
  noGenCount Int @default(0)

  // ë°˜ëŒ€í¸ê³¼ @relation ì´ë¦„ ì¼ì¹˜
  lootItems       LootItem[]         @relation("TimelineLootItems")
  distributions   LootDistribution[] @relation("TimelineDistributions")
  treasuryEntries TreasuryLedger[]   @relation("TimelineTreasuryEntries")

  createdAt DateTime @default(now())

  @@index([clanId], name: "idx_timeline_clan")
}

model LootItem {
  id         BigInt       @id @default(autoincrement())
  timelineId BigInt
  timeline   BossTimeline @relation("TimelineLootItems", fields: [timelineId], references: [id])

  itemName   String    @db.VarChar(100)
  isSold     Boolean   @default(false)
  soldAt     DateTime?
  soldPrice  Int?
  toTreasury Boolean   @default(false)

  /// ë£¨íŒ…ì ì•„ì´ë””
  lootUserId String? @default("") @db.VarChar(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy String @db.VarChar(50)

  distributions   LootDistribution[] @relation("ItemDistributions")
  treasuryEntries TreasuryLedger[]   @relation("LootItemTreasuryEntries")

  @@index([timelineId], name: "idx_lootitem_timeline")
}

model LootDistribution {
  id BigInt @id @default(autoincrement())

  timelineId BigInt
  lootItemId BigInt?

  timeline BossTimeline @relation("TimelineDistributions", fields: [timelineId], references: [id])
  lootItem LootItem?    @relation("ItemDistributions", fields: [lootItemId], references: [id])

  recipientLoginId String    @db.VarChar(50)
  amount           Int?
  isPaid           Boolean   @default(false)
  paidAt           DateTime?

  createdAt DateTime @default(now())
  createdBy String   @db.VarChar(50)

  @@index([timelineId], name: "idx_distribution_timeline")
  @@index([lootItemId], name: "idx_distribution_lootitem")
}

enum TreasuryEntryType {
  SALE_TREASURY // ë³´ìŠ¤ ë“œë ì•„ì´í…œ íŒë§¤ê¸ˆ ìœ ì…
  MANUAL_IN // ìˆ˜ë™ ì…ê¸ˆ
  MANUAL_OUT // ìˆ˜ë™ ì¶œê¸ˆ(ì§€ì¶œ)
}

model TreasuryLedger {
  id BigInt @id @default(autoincrement())

  clanId BigInt
  clan   Clan   @relation("ClanTreasuryEntries", fields: [clanId], references: [id])

  timelineId BigInt?
  timeline   BossTimeline? @relation("TimelineTreasuryEntries", fields: [timelineId], references: [id])

  lootItemId BigInt?
  lootItem   LootItem? @relation("LootItemTreasuryEntries", fields: [lootItemId], references: [id])

  entryType TreasuryEntryType
  amount    Int
  note      String?           @db.VarChar(255)

  // ì´ ì‹œì  ëˆ„ì  ì”ì•¡(ìŠ¤ëƒ…ìƒ·)
  balance Int

  createdBy String   @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([clanId, createdAt], name: "idx_treasury_clan_created")
  @@map("treasury_ledger")
}

model BossCounter {
  id BigInt @id @default(autoincrement())

  clanId BigInt
  clan   Clan   @relation("ClanBossCounters", fields: [clanId], references: [id])

  bossName  String @db.VarChar(50)
  dazeCount Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clanId, bossName], name: "uq_bossCounterClanBoss")
  @@index([clanId], name: "idx_bossCounterClan")
}

model Feedback {
  id      BigInt         @id @default(autoincrement())
  title   String         @db.VarChar(200)
  content String
  status  FeedbackStatus @default(WRITTEN)

  // ì‘ì„±ì
  authorId BigInt
  author   User   @relation("FeedbackAuthor", fields: [authorId], references: [id])

  // ì²˜ë¦¬ ë‹´ë‹¹ì
  handledById BigInt?
  handledBy   User?   @relation("FeedbackHandler", fields: [handledById], references: [id])

  // ì†Œí”„íŠ¸ ì‚­ì œ
  deleted     Boolean   @default(false)
  deletedAt   DateTime?
  deletedById BigInt?
  deletedBy   User?     @relation("FeedbackDeleter", fields: [deletedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ğŸ”´ ì—¬ê¸°ë§Œ ë‚¨ê¸°ê³ , ê°™ì€ ëª¨ë¸ì„ ê°€ë¦¬í‚¤ëŠ” ë‹¤ë¥¸ ë°°ì—´ í•„ë“œ(FeedbackComment FeedbackComment[])ëŠ” ì‚­ì œ
  comments FeedbackComment[] @relation("Feedback_Comments")

  @@index([createdAt])
  @@index([authorId, createdAt])
  @@index([status, createdAt])
  @@index([deleted, createdAt])
  @@index([title])
}

model FeedbackComment {
  id BigInt @id @default(autoincrement())

  feedbackId BigInt
  feedback   Feedback @relation("Feedback_Comments", fields: [feedbackId], references: [id], onDelete: Cascade)

  authorId BigInt
  author   User   @relation("FeedbackCommentAuthor", fields: [authorId], references: [id])

  content String

  deleted     Boolean   @default(false)
  deletedAt   DateTime?
  deletedById BigInt?
  deletedBy   User?     @relation("FeedbackCommentDeleter", fields: [deletedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([feedbackId, createdAt])
  @@index([authorId, createdAt])
  @@index([deleted])
}
